{{#template name="tutorial.step_05.md"}}
{{> downloadPreviousStep stepName="step_04"}}

На этом этапе вы научитесь создавать шаблон макета и как строить приложение, которое имеет различные отображения через добавление маршрутов используя Angular 1 модуль называемый `ui-router`.

Цели этого этапа:

* Когда вы переходите к `index.html`, вы будете перенаправлены к `index.ng.html/parties` и список вечеринок должен появится в браузере.
* Когда вы нажимаете ссылку вечеринки URL должен поменятся на соответствующий этой вечеринке иstub of a party detail page is displayed.


# Зависимости

Функциональность маршрутов добавленная на этом этапе обеспечена модулем [ui-router](https://github.com/angular-ui/ui-router), который распространяется отдельно от ядра Angular 1.

Мы установим ui-router с помощью [официального пакета Meteor](https://atmospherejs.com/angularui/angular-ui-router).

Наберите это в командной строке:

    meteor add angularui:angular-ui-router

Далее добавьте ui-router как зависимость к нашему приложению в `app.js`:

{{> DiffBox tutorialName="angular-meteor" step="5.2"}}

# Множественные отображения, маршрутизация и шаблон макета

Наше приложение медленно растёт и стаёт более сложным.
До этого момента приложение выдавало пользователям только одно отображение (список всех вечеринок) и весь код шаблона находился в файле `index.ng.html`.

Следующим шагом добавим отображение, которое покажет детальную информацию про каждую вечеринку в нашем списке.

Для добавления детального вида, мы могли бы расширить файл `index.ng.html` и поместить туда код обеих отображений, но всё станет очень быстро запутанным.

Вместо этого, мы переделаем шаблон `index.html` в так называемый "шаблон макета". Это шаблон общий для всех отображений в нашем приложении.

Другие "частные шаблоны" включаются в этот шаблон макета в зависимости от текущего "маршрута" -  отображения, которое выводится в данный момент пользователю.

Маршруты приложения в Angular 1 декларируются через [$stateProvider](https://github.com/angular-ui/ui-router/wiki), который является провайдером службы $state.
Эта служба облегчает соединение контроллеров, шаблонов отображений и текущее URL положение в браузере.
Используя эту функцию мы можем развернуть глубокую перелинковку, которая позволит нам использовать историю браузера (навигацию вперёд-назад) и закладки.


# Шаблон

Служба $state обычно используется вместе с директивой uiView.
Роль директивы uiView - включить шаблон отображения для текущего маршрута в шаблон макета.
Это отлично подходит для нашего `index.ng.html` шаблона.

Давайте создадим новый html-файл `parties-list.ng.html` и вставим существующий код списка из `index.ng.html` в него:

{{> DiffBox tutorialName="angular-meteor" step="5.3"}}

Код почти такой же за исключением двоих изменений:

- Добавленна ссылка с названиями вечеринок (эта ссылка ведёт на детальную страницу вечеринки)
- Удаление div с ng-controller информацией будет обработан определением маршрутов (см. дальше)

Вернёмся к `index.html` и заменим содержимое с директивой `ui-view`:

{{> DiffBox tutorialName="angular-meteor" step="5.4"}}

Обратите внимание - мы сделали 3 вещи:

1. Заменили весь контенк с ui-view (это будет отвечать за включение правильного содержимого при нажатии на текущий URL).
2. Добавили `h1` header with a link to the main parties page.
3. Также мы добавили тег `base` в наш head (нужен при использовании HTML5 режима локации).

Теперь мы можем удалить `index.ng.html` файл, он уже больше не используется.

Добавим плейсхолдер в новую страницу деталей вечеринки.
Создайте новый html файл с названием `party-details.ng.html` и вставьте следующий код:

{{> DiffBox tutorialName="angular-meteor" step="5.6"}}

Этот код может служить как плейсхолдер. Мы вернёмся к заполнению деталей попозже.

# Определение маршрутов

Сконфигурируем наши маршруты.
Добавим этот код конфигурации в `app.js`, после определения приложения Angular 1:

{{> DiffBox tutorialName="angular-meteor" step="5.7"}}

Используя .config() метод приложения Angular 1 мы запрашиваем `$stateProvider` вставиться в нашу config функцию и использовать метод состояния для определения наших маршрутов.

Наши маршруты приложения определяются следующим образом:

* **('/parties')**: Отображение списка вечеринок будет показано, когда фрагмент хеша - /parties. Для создания этого отображения Angular 1 будет использовать шаблон parties-list.ng.html и контроллер PartiesListCtrl.
* **('/parties/:partyId')**: Отображение деталей вечеринки будет показано, когда фрагмент хеша URL будет соответствовать '/parties/:partyId', где :partyId это переменная часть URL. Для создания отображения деталей вечеринки Angular использует шаблон party-details.ng.html и контроллер PartyDetailsCtrl.
* **$urlRouterProvider.otherwise('/parties')**: Запускает перенаправление к /parties когда адрес браузера не соответствует никакому из маршрутов.
* **$locationProvider.html5Mode(true)**: Устанавливает URL в обычный вид, подробнее об этом [здесь](https://docs.angularjs.org/guide/$location#hashbang-and-html5-modes).
* Каждый шаблон загружается по своему **абсолютному пути** к корневому каталогу проекта ('party-details.ng.html'). Это осуществляется из-за angular-meteor процесса построенния, который загружает шаблоны в кеш и именует их исходя из их путей.
Если шаблоны приходят из пакета, они получат префикс пакета следующим образом - 'my-app_my-package_client/views/my-template.ng.html'.
Можете подробнее почитать о процессе построения шаблонов в [нашем коде](https://github.com/Urigo/angular-meteor/blob/master/plugin/handler.js).

Обратите внимание, что используем параметр `:partyId` при описании второго маршрута.
Служба $state использует описание маршрута — `/parties/:partyId` — как шаблон, отвечающий текущему URL.
Все переменные определены с помощью : нотации и извлекаются в отдельный объект $stateParams.

# Контроллеры

Как вы уже заметили, мы убрали определение контроллера из директивы ng-controller в файле `index.ng.html` и поместили его в описание маршрута.

Но по-прежнему нам нужно определить контроллер `PartyDetailsCtrl`.
Добавьте этот код в существующий контроллер:

{{> DiffBox tutorialName="angular-meteor" step="5.8"}}

Всё теперь на месте. Запустите приложение и вы увидите две вещи:

* Клик по ссылки имени вечеринки - обратите внимание вы попали в другое отображение и вот здесь появилось id вечеринки в url браузера и в шаблоне.
* Клик назад - вы снова в основном списке, это случилось из-за интеграции ui-router с историей браузера.
* Попробуйте ввести какой-то нестандартный URL - что-то типа http://localhost:3000/strange-url. Вы автоматически перенаправитесь в основной список вечеринок.

#### Типичные ошибки

Если вы не ввели правильный абсолютный путь при определении маршрутов (например случайно ввели относительный путь), тогда вы может получить ошибку:

WARNING: Tried to load angular more than once.

В этом случае перепроверьте ваши пути и помните об использовании расширения файлов `.ng.html`.


# Итоги

С установкой маршрутов и отображения списка вечеринок, мы готовы перейти к следующему этапу и создать отображение деталей вечеринки.

{{/template}}
