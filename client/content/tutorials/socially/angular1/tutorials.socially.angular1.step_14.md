{{#template name="tutorials.socially.angular1.step_14.md"}}
{{> downloadPreviousStep stepName="step_13"}}

На этом этапе мы изучим как использовать [методы Meteor](http://docs.meteor.com/#/full/meteor_methods) и как использовать метод `Meteor.call` в нашем коде AngularJS.

Методы Meteor - это способ осуществлять более комплексную логику, чем просто Mongo.Collection API.
Методы Meteor также отвечают за проверку разрешений, совсем как делает метод allow.

В нашем случае мы создадим наш метод invite, который приглашает пользователя на вечеринку.

Вставьте следующий код в конец файла `parties.js` в папку model:

{{> DiffBox tutorialName="meteor-angular1-socially" step="14.1"}}

Давайте взглянем на код.

Во-первых, все методы Meteor определяются всередине объекта `Meteor.methods({});`.

Каждое свойство этого объекта - это метод и название этого свойства в имени - это название метода. В нашем случае - invite.

Далее значение свойства - это функция, которую мы вызываем. В нашем случае она принимает 2 параметра - пользовательский id и id приглашённого пользователя.

Вначале проверим валидацию функцией [check](http://docs.meteor.com/#check_package).

Для использования [check](http://docs.meteor.com/#check_package) нам нужно добавить [пакет check](https://atmospherejs.com/meteor/check):

    meteor add check

Остальной код понятен сам по себе, но важно также обратить внимание на функцию Email, которая отсылает email приглашённому пользователю.
Эта функция может быть вызвана из клиента, поэтому нам нужно разместить её всередине оператора `isServer`.

Не забудьте добавить пакет email к вашему проекту через командную строку:

    meteor add email

Давайте вызовем этот метод из клиента.

Добавьте метод к компоненту с названием `invite`:

{{> DiffBox tutorialName="meteor-angular1-socially" step="14.4"}}

Мы просто использовали просто Meteor API для вызове метода всередине нашего компонента.

Обратите внимание, что мы также использовали другой параметр - колбек функцию, которая вызывается, когда Meteor заканчивает работу с нашим методом.

Колбек имеет 2 параметра:

* Параметр 1 - `error` - будет `undefined` при успешном вызове.
* Параметр 2 - `result` - будет возвращена величина из метода сервера.

Давайте добавим кнопку для приглашения каждого желаемого пользователя. Отредактируйте списки пользователей в компоненте `partyDetails`, чтобы они приняли вид:

{{> DiffBox tutorialName="meteor-angular1-socially" step="14.5"}}

Теперь у нас работает функция для приглашения, дальше нам нужно опубликовать вечеринки приглашённым пользователям.
Давайте добавим это разрешение к методу публикации вечеринок:

{{> DiffBox tutorialName="meteor-angular1-socially" step="14.6"}}

### Отправка Email

Обратите внимание, если вы хотите протестировать функциональность email локально с помощью вашего gmail аккаунта, то создайте новый файл `environments.js` в папке `server/startup/`. Добавьте следующие строки заменив значения [YOUR_EMAIL] и [YOUR_PASSWORD].  

    Meteor.startup(function () {
        process.env.MAIL_URL="smtp://[YOUR_EMAIL]@gmail.com:[YOUR_PASSWORD]@smtp.gmail.com:465/";
    })

Вам может понадобиться установить ваш gmail аккаунт с настройками для использования [Less Secure Apps](https://www.google.com/settings/u/2/security/lesssecureapps).

В продакшене вы можете использовать такой сервис как Mandrill с помощью [пакета Mandrill](https://atmospherejs.com/wylio/mandrill).

Отлично!

Протестируем приложение. Создайте частную вечеринку с пользователем user1. Далее пригласите пользователя user2. Залогинтесь как user2 и проверьте видите ли вы вечеринки в его списке.


Добавьте RSVP функциональность, чтобы приглашённые пользователи могли отвечать на приглашения.

Давайте добавим метод `Meteor.method` к `parties.js` в папке model (помните, что нужно разместить его как свойство всередине объекта `Meteor.methods`):

{{> DiffBox tutorialName="meteor-angular1-socially" step="14.7"}}

Функция получает id и ответ ('yes', 'maybe' или 'no').

Как и метод invite, сначала мы проверим все типа валидации, а затем необходимую логику.

Давайте вызовем эту функцию из компонента `partiesList`!

Добавьте метод `rsvp` к компоненту `partiesList`:

{{> DiffBox tutorialName="meteor-angular1-socially" step="14.8"}}

и добавим кнопки действий для вызова соответствующих rsvp метедом в HTML.

Добавьте этот код к `parties-list.html` всередине списка вечеринок (всередине `ng-repeat`):

{{> DiffBox tutorialName="meteor-angular1-socially" step="14.9"}}

Давайте выведем список тех, кто приходит на каждую вечеринку.

Сразу после добавленного кода (всередине вечеринок `dir-paginate`) добавьте следующий код:

{{> DiffBox tutorialName="meteor-angular1-socially" step="14.10"}}

Нам нужно реализовать метод `getUserById`:

{{> DiffBox tutorialName="meteor-angular1-socially" step="14.11"}}

Сначала взгляните на фильтр с длинной, чтобы выяснить сколько людей ответило, с каждым типом ответа.

Далее взгляните на использование ng-repeat всередине `dir-paginate` - `ng-repeat` на RSVP всередине вечеринки из вечеринок `dir-paginate`.

Далее добами список пользователей, которые ещё не ответили, сразу под кодом, что мы только добавили:

{{> DiffBox tutorialName="meteor-angular1-socially" step="14.12"}}

Снова, `ng-repeat` всередине `dir-paginate`.  В этот момент мы вызываем функцию, которая даст нам всех пользователей, которые не ответили на эту отдельную вечеринку.

Добавьте функцию внутрь компонента `partiesList`:

{{> DiffBox tutorialName="meteor-angular1-socially" step="14.13"}}

Здесь мы используем underscore методы `_.filter`, `_.contains` и `_.findWhere` для получения приглашённых на вечеринку пользователей, но которые не вошли в rsvp массив.

Добавим коллекцию пользователей к компоненту:

{{> DiffBox tutorialName="meteor-angular1-socially" step="14.14"}}

# Итоги

Запустим приложение.

Посмотрите что у нас получилось с необходимой функциональности, но ещё видно много недоделок.
Есть вещи, которые мы можем скрыть, если пользователь не авторизирован или они пусты.

В следующей главе мы научимся нескольким простым, но очень полезным директивам Angular 1, которые помогут нам добавлять или удалять DOM исходя из определённых условий.

{{/template}}
