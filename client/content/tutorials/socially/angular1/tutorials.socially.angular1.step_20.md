{{#template name="tutorials.socially.angular1.step_20.md"}}
{{> downloadPreviousStep stepName="step_19"}}

На этом этапе мы добавим возможность заливать изображения в наше приложение, а также сортировать их и давать названия.

Angular-Meteor может использовать сборку пакетов [CollectionFS](https://github.com/CollectionFS/Meteor-CollectionFS), которые вместе обеспечивают полную поддержку файлов, включая заливку, загрузку, хранение, синхронизацию, манипуляцию и копирование.

Он поддерживает несколько адаптеров хранения для сохранения файлы на локальные файловые системы, GridFS, Amazon S3 или DropBox, и дополнительные адаптеры хранения могут быть созданы.

Процес очень похож на работу с любыми другими MongoDB коллекциями!

Давайте добавим заливку изображений к нашему приложению!


Начнём с добавления пакета CollectionFS к нашему проекту, запустим команду:

    $ meteor add cfs:standard-packages

Теперь решим какой адаптер хранения мы хотим использовать.
В этом примере мы будем использовать GridFS как адаптер хранения, добавим его используя команду:

    $ meteor add cfs:gridfs

Внимание: можете узнать подробную информацию про Хранилища и Адаптеры хранения в [CollectionFS](https://github.com/CollectionFS/Meteor-CollectionFS) репозитории.

Теперь у нас есть поддержка CollectionFS и установленный адаптер хранения, нам нужно теперь создать объект CollectionFS для работы с файлами.
Обратите внимание, вам нужно будет определить коллекцию как расшаренный ресурс, так как вам нужно будет использовать коллекцию в обеих - клиенте и сервере.

### Создание CollectionFS

Начнём с создания `model/images.js` файла и определим постоянный объект CollectionFS под названием "Images".
Также мы будем использовать CollectionFS API, который позволит нам определить наши права авторизации.
Наконец, мы опубликуем коллекцию как и любую другую с целью позволить клиенту подписываться на эти изображения:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.3"}}

Добавим постоянную подписку к публикациям `images` и также добавим коллекцию `Images` как хелпер:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.4"}}

Теперь у нас есть коллекция и мы можем создать клиент, который будет управлять загрузкой изображений.

### Загрузка изображений

Для загрузки файла вы можете использовать базовый HTML `<input type="file">` или любой другой пакет - вам только нужен HTML5 файловый объект.

Для нашего приложения мы бы добавили возможность drag-and-drop изображений, поэтому мы используем AngularJS директиву, которая обрабатывает загрузку файла и даёт нам больше функций - drag & drop, валидацию файлов на клиенте.
В этом примере, я буду использовать [ng-file-upload](https://github.com/danialfarid/ng-file-upload), у которого есть много фич для загрузки файлов.
С этой целью добавим пакет к нашему проекту:

    $ meteor add danialfarid:ng-file-upload

Добавим зависимость в файл `app.js`:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.6"}}

Добавим использование `ng-file-upload` к новому модальному окну:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.7"}}

Добавим некоторые правила CSS, чтобы окно загрузки выглядело чуть лучше и также создадим область для drag & drop:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.8"}}

И конечно же импортируем этот файл:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.9"}}

Добавим метод `addImages` к нашему компоненту:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.10"}}

> обратите внимание, что `addImages` использует в `nfg-change` атрибут html файл, который мы только создали.

Вот и всё! Теперь мы можем загрузить изображения используя только перетаскивание!
Обратите внимание что интерфейс приложения по-прежнему не показывает загруженные изображения... этим мы займёмся чуть позже.
Добавим ещё пару крутых функций. Давайте сделаем процес загрузки изображений наглядным!

### Обрезка изображений

Обычно загруженные изображения нужно редактировать перед сохранением.
Добавим к нашему примеру возможность обрезки изображений перед заливкой на серевер, используя пакет [ngImgCrop](https://github.com/alexk111/ngImgCrop/).
Давайте добавим его к нашему проекту:

    $ meteor add alexk111:ng-img-crop

Добавим зависимость в наш модуль:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.12"}}

Нам нужно делать обрезку на клиенте перед сохранением их в `CollectionFS`, давайте получим загруженное изображение и вместо сохранения его на сервер - получим его Data Url и используем его в `ngImgCrop`:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.15"}}

Мы взяли объект файла и использовали HTML5 FileReader API для чтения файла из пользователя на клиенте без его загрузки на сервер.
Далее мы сохранили DataURI изображения в переменную.
Далее, мы будем использовать этот DataURI с директивой `ngImgCrop` следующим образом:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.13"}}

>Далее мы добавим `ng-hide` к управлению заливкой, чтобы скрыть его, после того, как пользователь выберет изображение для обрезки.

Добавим чуть CSS, чтобы преобразить внешний вид:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.14"}}

Добавим кнопку для сохранения обрезанного изображения.

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.16"}}

Чтобы сохранить, нам нужно реализовать функцию `saveCroppedImage()`. Мы будем использовать то же `CollectionFS` API, которое мы использовали до этого с методом `insert`.

CollectionFS имеет возможность получать DataURI и сохранять его совсем как файловый объект. Поэтому реализация будет выглядеть вот так:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.17"}}

Мы получаем объект изображения и сохраняем его в CollectionFS и ложим его в массив `images`, который будет содержать изображения новой вечеринки.

Далее мы сбрасываем форму обновляя значение переменной `cropImgSrc` (мы использовали её в `ng-hide`).

Мы также меняем login в методе `addNewParty`, мы берём только свойство `_id` изображений, так как нам нужно сохранять id, а не целый объект изображения при его сохранении.

Мы почти закончили. Теперь у нас есть возможность обрезать изображения и сохранять их используя CollectionFS.

Не хватает только вывода залитых изображений в нашей форме!

### Вывод залитых изображений

Добавим простую галерею к списку изображений в форме новой вечеринки:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.18"}}

Вот и всё! Мы повторили их и использовали встроенный метод `.url()`!

Добавим описание к нашим изображениям!

### Метаданные изображений и описание

Используя CollectionFS, мы можем также хранить метаданные файлов, что мы храним.
С этой целью, нам нужно обновить свойство `metadata` объекта изображения.

С целью создания отличного интерфейся я использоватл [angular-xeditable](https://github.com/vitalets/angular-xeditable).
Добавим angular-xeditable пакет к проекту:

    $ meteor add vitalets:angular-xeditable

Добавим зависимость в наш модуль:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.20"}}

Давайте использовать `angular-xeditable` и добавим использование его для изображения:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.21"}}

Из-за проблемі с открытием тикетов для [angular-xeditable](https://github.com/vitalets/angular-xeditable/issues/6) 
Нам нжуно сменить `form` в `add-new-party-modal.html` на `div`, чтобы сделать инлайн редактирование `angular-xeditable` рабочим.

И, конечно же, реализовать функцию `updateDescription` области видимости вечеринок:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.22"}}

> Мы снова использовали CollectionFS API, используя метод `update()` и мы положим описание в свойство `metadata.description`.

Вот и всё! теперь у нас есть фото-галерея с описанием для каждого изображения!

### Сортировка изображений

После того, как мы научились пользоваться метаданными CollectionFS и как обновлять значения метаданых, мы также можем добавить возможность сортировки и обновления порядка изображений.
Для получения возможности сортировки изображений, давайте используем [angular-sortable-view](https://github.com/kamilkp/angular-sortable-view).

Добавим пает запустив эту команду:

    $ meteor add netanelgilad:angular-sortable-view

Добавим зависимость к модулю:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.24"}}

Основой `angular-sortable-view` является добавление `sv-?` аттрибутов к нашей странице, совсем как примеры в репозитории `angular-sortable-view` репозитории. Давайте сделаем это:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.25"}}

> Также добавили `draggable="false"` для предотвращения поведения браузера при перетаскивании изображений по-умолчанию.

Также мы можем добавить подсветку первого изображения, которое мы будем использовать как основное изображение, используя для этого индикацию:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.26"}}

Добавим CSS для улучшения вида:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.27"}}

Теперь у нас есть галерея изображений с возможностью добавлять изображения, редактировать их, добавлять описание и сортировать.
Теперь добавим логику, которая соединит эти изображения с создаваемой вечеринкой!

### Привяжите изображение к объекту

Как вы знаете, у нас есть изображения хранимые в `newParty.images` массиве и мы сменили метод `addNewParty` на этапе 20.17 для сохранения только id изображений.

Наконец, для вывода основного изображения в списке вечеринок добавим следующий код к компоненту:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.29"}}

И реализуем функцию `getMainImage`:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.28"}}

Добавим CSS для улучшения его вида:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.30"}}

Вот и всё!

### Миниизображения

Вместе с заливкой изображений необходимой функцией является сохранение миниизображений после заливки. 
CollectionFS даёт возможность хранить множественные объекты хранения и делать различные манипуляции перед тем, как мы сохраним его в каждом хранилище.
Вы можете найти полную информацию про манипуляции над изображениями в [документации CollectionFS](https://github.com/CollectionFS/Meteor-CollectionFS#image-manipulation).

Убедитесь, что вы добавили пакет graphicsmagick вставив следующую строку в терминале:

    $ meteor add cfs:graphicsmagick

Для подробной информации следуйте инструкциям на [CollectionFS](https://github.com/CollectionFS/Meteor-CollectionFS) GitHub странице.
Для добавления возможности хранить миниизображения, создадим новое хранилище в `images.js` и используем возможность `transformWrite`:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.31"}}

Теперь каждое загруженное изображение будет также храниться как миниизображение.
Теперь, чтобы выводилось миниизображение вместо оригинала, нужно добавить параметр к методу `url()` объектов файла и решить какое хранилище использовать при создании URL:

{{> DiffBox tutorialName="meteor-angular1-socially" step="20.32"}}

Вот и всё! Добавим возможность хранить миниизображения для изображений и используем их в отображении!

{{/template}}
